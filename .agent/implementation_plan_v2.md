# 集計誤差修正・実装計画書 V3 (✅ 実装・完了済み)

ユーザーからのフィードバックを反映し、曖昧さを排除した詳細計画書です。

## 1. 修正方針の定義

### A. 空白処理（データクリーニング）
*   **対象**: 売上CSV・マスタExcel・会員CSVの全文字列カラム
*   **処理内容**: **「前後（Leading/Trailing）の空白削除」のみ**を行います。
    *   Pythonの `.str.strip()` を使用します。これにより、半角スペース ` ` だけでなく、全角スペース `　` (`\u3000`) も除去されます。
    *   **重要**: 文字列**中間**のスペースは一切削除・変更しません。（例: `A　中学校` → `A　中学校` のまま維持）これにより、別名の学校が同一視されるリスクを排除します。

### B. マッチングとマスタチェックの整合性 (Policy Unification)
集計時の「紐づけルール」と、事前チェックの「バリデーションルール」を完全に一致させます。

#### 1. 紐づけ判定ルール (Aggregation Logic)
各マスタレコード（学校）に対して、以下の順序で売上データを紐づけ（抽出）します。
1.  **ID完全一致**: `売上.学校ID == マスタ.ID` となる売上レコードを探す。
2.  **名称フォールバック**: 1でヒットが0件の場合のみ、`売上.学校名(strip済) == マスタ.学校名(strip済)` となる売上レコードを探す。
3.  **判定**:
    *   IDで一致すれば採用（その際、名前が違っても**警告ログを出して許容**する）。
    *   ID不一致でも、名前が一致すれば採用。

#### 2. 事前バリデーションルール (Strict Validation)
売上データの全レコードに対して、以下の条件でチェックを行います。
*   **OK判定条件**: `(売上.学校ID が マスタ.ID に存在する) OR (売上.学校名 が マスタ.学校名 に存在する)`
*   **NG判定条件**: 上記のどちらにも該当しないレコードが1件でも存在する場合。
*   **動作**: NGレコードがある場合、**即時エラー停止 (`SchoolMasterMismatchError`)** します。
    *   これにより、「ID未登録だが名前は合っている」既存のデータ（10万円相当）は**正常**として扱われます。
    *   「IDも名前もマスタにない」真の不明データのみを弾きます。

## 2. 具体的な実装内容

### [1] ファイル読み込み (`app/backend/services/file_handler.py`)
*   `read_sales_csv` / `read_accounts_csv` / `read_master_excel`
    *   読み込み後、object型カラムに対して `.str.strip()` を適用。
    *   CSV読み込み時のエンコーディングフォールバック処理を追加。

### [2] 集計ロジック (`app/backend/aggregator/sales.py`)

#### 全メソッドへの適用
以下の全集計メソッドに対して、上記の「ID優先・名称フォールバック」ロジックを適用します。
*   `_aggregate_by_branch` (事業所別)
*   `_aggregate_by_salesman` (担当者別)
*   `_aggregate_by_event` (イベント別)
    *   ※従来の `_aggregate_by_branch` は名前一致のみでしたが、ここも整合性を取るためID判定を導入します。

#### `_check_school_master` (改修)
*   「DBチェック」を廃止。
*   「売上データの学校IDまたは学校名が、Excelマスタに存在するか」をチェックするロジックに変更。
*   NG時はエラー詳細（該当する学校名とID）を表示して停止。

#### `_update_schools_master`
*   変更なし（Excelの内容を正としてDB更新）

## 3. テスト計画

本修正の安全性を担保するため、検証スクリプト (`verify_fixes_logic.py`) に以下のテストケースを追加します。

### 回帰テスト (Regression Test)
*   **総和の一致確認**: 以下の4つの合計値が完全に一致することを確認します。
    *   `result.summary.total_sales` (全体売上)
    *   `sum(branch.sales)` (事業所計)
    *   `sum(salesman.sales)` (担当者計)
    *   `sum(school.sales)` (学校計)

### ケース別テスト
1.  **空白処理**: ` A学園 `(半角) / `　B学園　`(全角) が正しくstripされ、マッチすること。
2.  **ID優先**: ID一致・名前不一致のデータが正しく集計されること。
3.  **名称フォールバック**: IDなし・名前一致のデータが正しく集計されること。
4.  **厳密チェック**: IDも名前も一致しないデータのみがエラーになること。

---
**修正後のこの計画で実装を進めます。**
Open Questionsへの回答:
1. ID不一致・名称一致: **「警告して通す（採用する）」** 仕様にします（ID優先ロジックのフォールバックで救済）。
2. 空白正規化: **「strip（前後）のみ」** です。中間スペースは維持します。Pythonのstripは全角空白も除去します。
3. マスタチェック基準: はい、**「filtered_df（キャンセル除外後）」** を基準に行います。

---

## 4. 実装・検証ログ (2026-02-10 〜 2026-02-11)

### 実装済み

1. `app/backend/services/file_handler.py`
   - CSVエンコーディングのフォールバック処理を追加。
   - 文字列カラム前後空白除去（中間空白保持）を共通適用。

2. `app/backend/aggregator/sales.py`
   - ID優先・名称フォールバックの学校マッチングを全内訳集計で統一。
   - マッチ済みデータを基準に、事業所別/担当者別/学校別/イベント別の整合を確保。
   - `filtered_df` 基準の厳密バリデーション（未登録学校があれば停止）を実装。

3. `dashboard_v2.py`
   - 条件別集計CSV出力（`downloadAlertCSV`）をタブ別定義へ改修。
   - 表示テーブルとCSV列の不一致を解消。

### 検証で確認できたこと

1. 既存データでは「真の未登録学校 5件」を検出し、意図通り停止する。
2. 未登録学校を除いた検証では、  
   総売上 = 事業所計 = 担当者計 = 学校計 が一致する。
3. 実績反映は `report_date` 一致時に同日レポートを置換する運用で成立する。
4. ダッシュボードは `reports.id` の最新を参照するため、反映後は最新レポートで再表示される。

### 補足

`python dashboard_v2.py` 実行時、Windows `cp932` 環境では  
`✅` 文字の `UnicodeEncodeError` で終了することがあるが、HTML生成自体は完了する。
