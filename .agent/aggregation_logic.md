# ダッシュボード集計ロジック一覧

**作成日**: 2026-01-05
**最終更新**: 2026-01-29 (V2ロジック改修反映)
**目的**: 各グラフ・表がどのテーブル/カラムを使って集計しているかを明確化

---

## 🚨 V2ロジック重要変更点 (2026-01-29)

従来のロジックに見つかった不具合を修正するため、以下の集計ルールが適用されています。
**開発者は必ずこのルールに従ってください。**

### 1. 売上集計は `SUM` を使用する (MAX禁止)
*   **理由**: イベント売上が分割入金（例：4月に一部、7月に残金）として `event_sales` テーブルに複数行で格納される場合があるため。
*   **旧ロジック**: `MAX(sales)` → 最大の入金1件しか計上されず、残りが欠落。
*   **新ロジック**: `SUM(sales)` → 全ての入金レコードを合算。

### 2. `report_id` によるフィルタリング必須
*   **理由**: 過去のレポートデータがDBに残っている場合、単純な `SUM` だと過去分まで二重計上されるリスクがあるため。
*   **ルール**: クエリには必ず `WHERE report_id = ?` (最新レポートID) を含めること。

### 3. イベント数のカウントは `DISTINCT` 必須
*   **理由**: 分割入金により、1つのイベントが複数行（レコード）として存在する。`COUNT(id)` や `COUNT(*)` では行数をカウントしてしまい、イベント数が倍増する。
*   **新ロジック**: `COUNT(DISTINCT event_name || event_date)` (SQLite結合) を使用してユニークイベント数をカウントする。

### 4. イベント一覧取得時は `GROUP BY` 必須
*   **理由**: 分割入金があるイベントをリスト表示する際、`GROUP BY` がないと分割回数分だけ行が表示されてしまう。
*   **新ロジック**: `GROUP BY event_name, event_date` を付与し、売上は `SUM(sales)` で合算して1行にまとめる。

---

## テーブル概要

| テーブル名 | 説明 | 集計ベース |
|-----------|------|-----------|
| `monthly_totals` | 月次全体売上 | **売上計上月** |
| `branch_monthly_sales` | 事業所別月次売上 | **売上計上月** |
| `manager_monthly_sales` | 担当者別月次売上 | **売上計上月** |
| `school_monthly_sales` | 学校別月次売上 | **売上計上月** |
| `event_sales` | イベント別売上 | `event_date`=**イベント開始日**、`fiscal_year`/`month`=**売上計上月** |
| `member_rates` | 会員率スナップショット | `snapshot_date`=スナップショット日 |

---

## ダッシュボード各セクションの集計ロジック

### 1. サマリーカード（上部の4つのカード）

| 項目 | 使用テーブル | 集計ベース | 備考 |
|-----|-------------|-----------|------|
| 今年度累計売上 | `monthly_totals` | **売上計上月** | `fiscal_year` + `month` でフィルタ |
| 前年同期売上 | `monthly_totals` | **売上計上月** | 同上 |
| 予算達成率 | `monthly_totals` | **売上計上月** | `budget` との比較 |
| イベント数 | `event_sales` | **売上計上月** | `fiscal_year` でフィルタ |

---

### 2. グラフセクション

| グラフ名 | 使用テーブル | 集計ベース | 備考 |
|---------|-------------|-----------|------|
| 月別売上推移 | `monthly_totals` | **売上計上月** | 4月〜3月の月別売上 |
| 事業所別売上 | `branch_monthly_sales` | **売上計上月** | 事業所ごとの月別集計 |
| 担当者別売上 | `manager_monthly_sales` | **売上計上月** | 担当者ごとの月別集計 |
| 学校別売上（個別詳細） | `school_monthly_sales` | **売上計上月** | 学校選択時の月別推移 |

---

### 3. 条件別集計セクション（売上・実績）

| 機能名 | 使用テーブル | 集計ベース | クエリの特徴 (V2修正版) |
|-------|-------------|-----------|-------------|
| **売上好調校** | `event_sales` | **イベント開始日** | `SUM(sales)` + `report_id`フィルタ |
| **新規開始校** | `event_sales` | **イベント開始日** | `SUM(sales)` + `MIN(event_date)` |

---

### 4. 条件別集計セクション（要注意・改善）

| 機能名 | 使用テーブル | 集計ベース | クエリの特徴 (V2修正版) |
|-------|-------------|-----------|-------------|
| **今年度未実施校** | `event_sales` | **イベント開始日** | `COUNT(DISTINCT event)` で実施有無判定 |
| **会員率・売上低下** | `event_sales` | **イベント開始日** | `SUM(sales)` で集計 |
| **写真館別低下** | `school_monthly_sales` | **売上計上月** | `fiscal_year` でフィルタ |

---

### 5. 条件別集計セクション（トレンド分析）

| 機能名 | 使用テーブル | 集計ベース | クエリの特徴 |
|-------|-------------|-----------|-------------|
| **会員率改善** | `member_rates` + `event_sales` | 会員率=スナップショット日、売上=**売上計上月** | 会員率は年度末スナップショット比較 |
| **販売単価分析** | `event_sales` | **売上計上月** | **`COUNT(DISTINCT ...)`** でイベント数算出 |

---

### 6. 条件別集計セクション（イベント関連）

| 機能名 | 使用テーブル | 集計ベース | クエリの特徴 |
|-------|-------------|-----------|-------------|
| **イベント開始日別売上** | `event_sales` | **イベント開始日** | `GROUP BY` + `SUM(sales)` で重複排除 |

---

## 問題点まとめ

### イベント開始日ベースの機能（4つ）
以下の機能は `event_date`（イベント開始日）を使って年度判定している：

1. 売上好調校
2. 新規開始校
3. 今年度未実施校
4. 会員率・売上低下

**特徴**:
- イベントが「いつ開催されたか」で年度を判定
- 例: 2025年4月1日以降に開催されたイベント = 2025年度

### 売上計上月ベースの機能
以下の機能は `fiscal_year` + `month`（売上計上月）を使っている：

1. サマリーカード（累計売上など）
2. 月別売上推移グラフ
3. 事業所別売上グラフ
4. 担当者別売上グラフ
5. 写真館別低下
6. 販売単価分析
7. 会員率改善（売上部分）

**特徴**:
- 売上が「いつ計上されたか」で年度を判定
- 例: 4月に売上計上 = その年度の4月分

---

## 集計ベースの違い（具体例）

### 例: 2024年4月30日に公開したイベントが、2025年5月5日に売上が発生した場合

| 集計ベース | 計上される年度 | 理由 |
|-----------|--------------|------|
| **イベント開始日ベース** | **2024年度** | イベント公開日（event_date）が2024年4月30日 → 2024年度のイベント |
| **売上計上月ベース** | **2025年度** | 売上発生月が2025年5月 → 2025年度5月の売上 |

### ポイント
- **イベント開始日ベース**: 「このイベントはいつ開催（公開）されたか？」で判定
- **売上計上月ベース**: 「この売上はいつ発生したか？」で判定

過去に公開したイベントでも、売上が発生し続ける限り「売上計上月ベース」では新しい年度に計上される。

---

## Excelとの対応関係

| Excelシート | 集計ベース | 対応するダッシュボード機能 |
|------------|-----------|------------------------|
| 学校別（2025年度） | **売上計上月** | 写真館別低下、販売単価分析 |
| イベント別（2025年度） | **イベント開始日** + **売上計上月** 混在 | イベント開始日別売上 |

### 具体例: 水戸英宏小学校

| 集計方法 | 2025年度売上 |
|---------|-------------|
| Excel「学校別（2025年度）」 | ¥81,030 |
| ダッシュボード「会員率・売上低下」 | ¥26,208 |

**差異の原因**:
- Excelは「売上計上月」ベース（4月に計上された売上は4月の売上）
- ダッシュボードは「イベント開始日」ベース（2025/04/01以降に開催されたイベントの売上）

---

## 推奨アクション (2025-01-29 追記)

**現在は「機能ごとに使い分け（現状維持）」を選択中。**
ただし、V2ロジック修正により、イベント単位の集計は「分割入金の合算（SUM）」によって精度が向上したため、
イベント開始日ベースの集計でも「売上の取りこぼし」は解消されている。

今後の方針：
*   トレンド分析や月次報告と合わせる場合 → **売上計上月ベース**
*   イベントの実施成績を評価する場合 → **イベント開始日ベース**
