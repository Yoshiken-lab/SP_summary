# ダッシュボード集計ロジック一覧

**作成日**: 2026-01-05
**目的**: 各グラフ・表がどのテーブル/カラムを使って集計しているかを明確化

---

## テーブル概要

| テーブル名 | 説明 | 集計ベース |
|-----------|------|-----------|
| `monthly_totals` | 月次全体売上 | **売上計上月** |
| `branch_monthly_sales` | 事業所別月次売上 | **売上計上月** |
| `manager_monthly_sales` | 担当者別月次売上 | **売上計上月** |
| `school_monthly_sales` | 学校別月次売上 | **売上計上月** |
| `event_sales` | イベント別売上 | `event_date`=**イベント開始日**、`fiscal_year`/`month`=**売上計上月** |
| `member_rates` | 会員率スナップショット | `snapshot_date`=スナップショット日 |

---

## ダッシュボード各セクションの集計ロジック

### 1. サマリーカード（上部の4つのカード）

| 項目 | 使用テーブル | 集計ベース | 備考 |
|-----|-------------|-----------|------|
| 今年度累計売上 | `monthly_totals` | **売上計上月** | `fiscal_year` + `month` でフィルタ |
| 前年同期売上 | `monthly_totals` | **売上計上月** | 同上 |
| 予算達成率 | `monthly_totals` | **売上計上月** | `budget` との比較 |
| イベント数 | `event_sales` | **売上計上月** | `fiscal_year` でフィルタ |

---

### 2. グラフセクション

| グラフ名 | 使用テーブル | 集計ベース | 備考 |
|---------|-------------|-----------|------|
| 月別売上推移 | `monthly_totals` | **売上計上月** | 4月〜3月の月別売上 |
| 事業所別売上 | `branch_monthly_sales` | **売上計上月** | 事業所ごとの月別集計 |
| 担当者別売上 | `manager_monthly_sales` | **売上計上月** | 担当者ごとの月別集計 |
| 学校別売上（個別詳細） | `school_monthly_sales` | **売上計上月** | 学校選択時の月別推移 |

---

### 3. 条件別集計セクション（売上・実績）

| 機能名 | 使用テーブル | 集計ベース | クエリの特徴 |
|-------|-------------|-----------|-------------|
| **売上好調校** | `event_sales` | **イベント開始日** (`event_date`) | `event_date >= '2025-04-01'` で年度判定 |
| **新規開始校** | `event_sales` | **イベント開始日** (`event_date`) | `MIN(event_date)` で初回開催日を判定 |

---

### 4. 条件別集計セクション（要注意・改善）

| 機能名 | 使用テーブル | 集計ベース | クエリの特徴 |
|-------|-------------|-----------|-------------|
| **今年度未実施校** | `event_sales` | **イベント開始日** (`event_date`) | 今年度 `event_date` の存在チェック |
| **会員率・売上低下** | `event_sales` | **イベント開始日** (`event_date`) | `event_date >= '2025-04-01'` で年度売上を集計 |
| **写真館別低下** | `school_monthly_sales` | **売上計上月** | `fiscal_year` でフィルタ |

---

### 5. 条件別集計セクション（トレンド分析）

| 機能名 | 使用テーブル | 集計ベース | クエリの特徴 |
|-------|-------------|-----------|-------------|
| **会員率改善** | `member_rates` + `event_sales` | 会員率=スナップショット日、売上=**売上計上月** (`fiscal_year`) | 会員率は年度末スナップショット比較 |
| **販売単価分析** | `event_sales` | **売上計上月** (`fiscal_year`) | `fiscal_year` + `report_id` でフィルタ |

---

### 6. 条件別集計セクション（イベント関連）

| 機能名 | 使用テーブル | 集計ベース | クエリの特徴 |
|-------|-------------|-----------|-------------|
| **イベント開始日別売上** | `event_sales` | **イベント開始日** (`event_date`) | ユーザーが年月日を指定してフィルタ |

---

## 問題点まとめ

### イベント開始日ベースの機能（4つ）
以下の機能は `event_date`（イベント開始日）を使って年度判定している：

1. 売上好調校
2. 新規開始校
3. 今年度未実施校
4. 会員率・売上低下

**特徴**:
- イベントが「いつ開催されたか」で年度を判定
- 例: 2025年4月1日以降に開催されたイベント = 2025年度

### 売上計上月ベースの機能
以下の機能は `fiscal_year` + `month`（売上計上月）を使っている：

1. サマリーカード（累計売上など）
2. 月別売上推移グラフ
3. 事業所別売上グラフ
4. 担当者別売上グラフ
5. 写真館別低下
6. 販売単価分析
7. 会員率改善（売上部分）

**特徴**:
- 売上が「いつ計上されたか」で年度を判定
- 例: 4月に売上計上 = その年度の4月分

---

## 集計ベースの違い（具体例）

### 例: 2024年4月30日に公開したイベントが、2025年5月5日に売上が発生した場合

| 集計ベース | 計上される年度 | 理由 |
|-----------|--------------|------|
| **イベント開始日ベース** | **2024年度** | イベント公開日（event_date）が2024年4月30日 → 2024年度のイベント |
| **売上計上月ベース** | **2025年度** | 売上発生月が2025年5月 → 2025年度5月の売上 |

### ポイント
- **イベント開始日ベース**: 「このイベントはいつ開催（公開）されたか？」で判定
- **売上計上月ベース**: 「この売上はいつ発生したか？」で判定

過去に公開したイベントでも、売上が発生し続ける限り「売上計上月ベース」では新しい年度に計上される。

---

## Excelとの対応関係

| Excelシート | 集計ベース | 対応するダッシュボード機能 |
|------------|-----------|------------------------|
| 学校別（2025年度） | **売上計上月** | 写真館別低下、販売単価分析 |
| イベント別（2025年度） | **イベント開始日** + **売上計上月** 混在 | イベント開始日別売上 |

### 具体例: 水戸英宏小学校

| 集計方法 | 2025年度売上 |
|---------|-------------|
| Excel「学校別（2025年度）」 | ¥81,030 |
| ダッシュボード「会員率・売上低下」 | ¥26,208 |

**差異の原因**:
- Excelは「売上計上月」ベース（4月に計上された売上は4月の売上）
- ダッシュボードは「イベント開始日」ベース（2025/04/01以降に開催されたイベントの売上）

---

## 推奨アクション

集計ロジックを統一するか、目的に応じて使い分けるかを決定する必要がある。

### 選択肢

1. **イベント開始日ベースに統一**
   - メリット: イベントの実施状況が正確にわかる
   - デメリット: Excelの「学校別」シートと数値が一致しない

2. **売上計上月ベースに統一**
   - メリット: Excelと数値が一致する
   - デメリット: 過去イベントの売上も「今年度」に計上される場合がある

3. **機能ごとに使い分け（現状維持）**
   - メリット: 目的に応じた適切な集計ができる
   - デメリット: 混乱しやすい、同じ学校でも機能によって数値が異なる
