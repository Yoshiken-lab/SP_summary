# スクールフォト売上分析システム 運用マニュアル

## 概要

このシステムは、スクールフォトの売上データを集計・分析し、Excel報告書とダッシュボードを生成します。

**2つの利用方法があります：**
- **Webアプリケーション版**（推奨）: ブラウザから操作する簡単なGUI
- **コマンドライン版**: Pythonコマンドで操作

---

## Webアプリケーション版（推奨）

### 起動方法

```bash
cd app
python run.py --port 8089
```

ブラウザで `http://127.0.0.1:8089` にアクセスします。

---

### 機能1: 月次集計

**目的**: 売上データ（CSV）から月次報告書（Excel）を作成する

#### 必要なファイル

| ファイル | 形式 | 内容 |
|---------|------|------|
| 売上データ | CSV | 売上明細（日付、金額、学校名など） |
| 会員データ | CSV | 会員情報（学校ごとの生徒数、会員数など） |
| 担当者マスタ | XLSX | 担当者・写真館と学校の紐付け情報 |

#### 操作手順

1. **「月次集計」タブ**を選択
2. **Step 1**: 3つのファイルを選択
   - 「売上データ (CSV)」→ 売上CSVファイルを選択
   - 「会員データ (CSV)」→ 会員CSVファイルを選択
   - 「担当者マスタ (XLSX)」→ マスタExcelを選択
3. **Step 2**: 対象の年度と月を選択
4. **「集計を実行」**ボタンをクリック
5. 完了後、Downloadフォルダに `SP_SalesResult_YYYYMM.xlsx` が出力される

#### 出力ファイル

- **ファイル名**: `SP_SalesResult_YYYYMM.xlsx`（例: SP_SalesResult_202504.xlsx）
- **出力先**: Downloadフォルダ
- **シート構成**:
  - 売上: 月次売上サマリー
  - 学校別: 学校ごとの売上詳細
  - イベント別: イベントごとの売上詳細
  - 会員率: 学校ごとの会員率データ

---

### 機能2: 累積集計

**目的**: 月次集計結果を年度ごとにまとめ、累積データを作成する

#### 必要なファイル

| ファイル | 形式 | 内容 |
|---------|------|------|
| 月次集計結果 | XLSX | 月次集計で出力したファイル（複数選択可） |
| 既存累積ファイル（任意） | XLSX | 追記したい既存の年度累計ファイル |

#### 操作手順

1. **「累積集計」タブ**を選択
2. **Step 1**: 月次集計ファイルを追加
   - ファイルを選択 → 年度・月を指定 → 「追加」
   - 複数のファイルを追加可能（例: 4月〜11月の8ファイル）
3. **Step 2（任意）**: 既存累積ファイルのパスを入力
   - 空欄の場合: Downloadフォルダに新規作成
   - パス指定の場合: そのファイルに上書き保存
4. **「累積集計を実行」**ボタンをクリック
5. 完了後、保存先パスが表示される

#### 出力ファイル

- **ファイル名**: `SP_年度累計_YYYY.xlsx`（例: SP_年度累計_2025.xlsx）
- **出力先**:
  - 既存ファイル指定なし → Downloadフォルダ
  - 既存ファイル指定あり → 指定したファイルに上書き

---

### 機能3: 実績反映（ダッシュボード）

**目的**: 月次集計結果をデータベースに反映し、分析ダッシュボードを生成・公開する

#### 必要なファイル

| ファイル | 形式 | 内容 |
|---------|------|------|
| 月次集計結果 | XLSX | 月次集計で出力したファイル（複数選択可） |

#### 操作手順

**【データ反映】**
1. **「実績反映」タブ**を選択
2. **セクション1**: 月次集計ファイルを追加
   - ファイルを選択 → 「追加」
   - 複数のファイルを追加可能
3. **「実績を反映」**ボタンをクリック
   - 重複データがある場合は警告が表示される
   - 「上書きして続行」で上書き反映が可能
4. 反映完了後、ダッシュボードが自動生成される

**【ダッシュボード公開】**
1. **セクション2**: ダッシュボード公開
   - 最終生成日時・最終公開日時を確認
2. **「プレビュー」**ボタンで内容を確認（別タブで開く）
3. 内容に問題がなければ**「ダッシュボードを公開」**ボタンをクリック
4. ファイルサーバーに公開される

#### 公開先

```
\\192.168.11.51\homes\dashboard\dashboard.html
```

---

## 運用フローの例

### 毎月の定期作業

```
1. 月次集計
   売上CSV + 会員CSV + マスタXLSX → SP_SalesResult_YYYYMM.xlsx

2. 累積集計
   SP_SalesResult_YYYYMM.xlsx → SP_年度累計_YYYY.xlsx に追記

3. 実績反映
   SP_SalesResult_YYYYMM.xlsx → データベース → ダッシュボード公開
```

### 年度初め（4月）

1. 月次集計で4月分を作成
2. 累積集計で新しい年度累計ファイルを作成（既存ファイル指定なし）
3. 実績反映でダッシュボードを更新

### 年度途中（5月以降）

1. 月次集計で当月分を作成
2. 累積集計で既存の年度累計ファイルに追記
3. 実績反映でダッシュボードを更新

---

## コマンドライン版

### コマンド一覧

| コマンド | 説明 |
|---------|------|
| `python main.py import <ファイル>` | 単一Excelファイルを取り込み |
| `python main.py import <フォルダ> --all` | フォルダ内の全Excelを取り込み |
| `python main.py publish` | ダッシュボード生成＆ファイルサーバーに公開 |
| `python main.py dashboard [ファイル名]` | ダッシュボードHTML生成（ローカルのみ） |
| `python main.py status` | DB状態確認 |
| `python main.py init --force` | DB初期化（全データ削除） |

### 使用例

```bash
# 報告書を取り込んでダッシュボード公開
python main.py import "SP_SalesResult_202504.xlsx"
python main.py publish

# 複数ファイルを一括取り込み
python main.py import "C:\報告書フォルダ" --all
```

---

## ダッシュボードの使い方

### 画面構成

1. **サマリーカード**（上部）
   - 累計売上、前年比、予算達成率、アラート件数を表示
   - 「月別売上推移」の年度選択と連動

2. **月別売上推移**（中央上）
   - 年度プルダウンで表示年度を切り替え可能
   - タブで「月ごと」「事業所ごと」「担当者ごと」を切り替え

3. **会員率推移・学校別売上推移**（中央下）
   - 独立した年度プルダウンで表示年度を切り替え可能
   - 属性・写真館・学校で絞り込んで検索

4. **アラート・分析**（下部）
   - 前年比大幅減の学校
   - 予算未達のイベント
   - 属性別の会員率統計

### フィルター操作

- **会員率推移**: 属性 → 写真館 → 学校 の順で絞り込み、「検索」ボタンで表示
- **学校別売上推移**: 事業所 → 写真館 → 学校 の順で絞り込み

---

## トラブルシューティング

### Webアプリが起動しない

```bash
# 必要なライブラリをインストール
pip install flask flask-cors openpyxl pandas

# ポートが使用中の場合は別ポートで起動
python run.py --port 8090
```

### 「担当者マスタに未登録の学校があります」エラー

- 売上データに含まれる学校が、担当者マスタに登録されていません
- 表示された学校名をマスタに追加してから再実行してください

### 累積集計で「ファイルが存在しません」

- 既存ファイルのパスが正しいか確認してください
- パスはフルパスで指定してください（例: `C:\Users\username\Downloads\SP_年度累計_2025.xlsx`）

### ダッシュボードが公開できない

- ファイルサーバー（`\\192.168.11.51`）への接続を確認してください
- ネットワークに接続されているか確認してください

---

## 設定機能

### 担当者名変換設定

**目的**: Excelの担当者名表記ゆれを統一する（例: 「佐藤」→「佐藤（邦）」）

#### 操作手順

1. **「実績反映」タブ**を選択
2. **担当者名変換設定**セクションで設定
   - 「変換元」に変換前の名前を入力（例: 佐藤）
   - 「変換先」に変換後の名前を入力（例: 佐藤（邦））
   - 「追加」ボタンをクリック
3. 登録済みの変換ルールは一覧に表示される
4. 不要なルールは「削除」ボタンで削除

#### 注意事項

- 変換は実績反映時に自動適用される
- 既存データには影響しない（新規反映時のみ適用）

---

### 学校担当者設定

**目的**: 特定期間の学校担当者を手動で設定・変更する

#### 操作手順

1. **「実績反映」タブ**を選択
2. **学校担当者設定**セクションで設定
   - 学校名を検索して選択
   - 年度、開始月、終了月を選択（終了月は「指定なし（継続中）」も選択可）
   - 担当者を選択
   - 「追加」ボタンをクリック
3. 登録済みの設定は一覧に表示される
4. 不要な設定は「削除」ボタンで削除

#### 注意事項

- 設定を追加すると、該当期間の既存売上データの担当者も更新される
- 担当者プルダウンの選択肢は `config.py` で管理

---

## 担当者リストの管理

学校担当者設定のプルダウンに表示される担当者リストは、`config.py` ファイルで管理されています。

### 担当者を追加する場合

1. `config.py` をテキストエディタで開く
2. `MANAGERS` リストに新しい担当者名を追加

```python
# 担当者リスト（学校担当者設定で使用）
MANAGERS = [
    '三室',
    '佐藤（恵）',
    '佐藤（邦）',
    # ... 既存の担当者 ...
    '新しい担当者',  # ← 追加
]
```

3. ファイルを保存
4. サーバーを再起動（ランチャーで停止→起動）

### 担当者を削除する場合

1. `config.py` をテキストエディタで開く
2. `MANAGERS` リストから該当の担当者名を削除
3. ファイルを保存
4. サーバーを再起動

### 注意事項

- 担当者名は正確に入力してください（括弧は全角）
- リストはあいうえお順で管理することを推奨
- この設定は学校担当者設定のプルダウン表示のみに使用され、他の処理には影響しません

---

## ファイル構成

```
SP_summary/
├── app/                    # Webアプリケーション
│   ├── backend/           # バックエンド（Flask API）
│   │   ├── api.py        # APIエンドポイント
│   │   ├── aggregator/   # 集計処理
│   │   └── services/     # サービス層
│   ├── frontend/          # フロントエンド（Vue.js）
│   │   └── src/
│   ├── run.py            # 起動スクリプト
│   └── config.py         # 設定
├── main.py               # CLIメインスクリプト
├── importer.py           # Excelインポート処理
├── dashboard.py          # ダッシュボード生成
├── database.py           # データベース操作
└── schoolphoto.db        # SQLiteデータベース
```

---

## 注意事項

- `schoolphoto.db` はデータベースファイルです。削除すると全データが失われます
- 報告書のバックアップは別途保管してください
- 月次集計の出力ファイルは累積集計・実績反映で使用するため保管してください
