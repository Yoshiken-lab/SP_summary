# スクールフォト売上分析システム 運用マニュアル

## 概要

このシステムは、スクールフォトの売上報告書（Excel）からデータを取り込み、分析ダッシュボードを生成します。

---

## 必要な環境

- Python 3.8以上
- 必要なライブラリ: `openpyxl`

```bash
pip install openpyxl
```

---

## ファイル構成

| ファイル | 役割 |
|---------|------|
| `main.py` | メインスクリプト（コマンド実行用） |
| `importer.py` | Excelファイル取り込み処理 |
| `dashboard.py` | ダッシュボードHTML生成 |
| `database.py` | データベース操作 |
| `member_rate_chart.py` | 会員率推移データ取得 |
| `alerts.py` | アラート分析 |
| `analytics.py` | 統計分析 |
| `schoolphoto.db` | SQLiteデータベース（自動生成） |

---

## 基本的な運用手順

### 1. 新しい報告書を取り込む

報告書のExcelファイル（`スクールフォト売上報告書_YYYYMMDD.xlsx`）を受け取ったら、以下のコマンドで取り込みます。

```bash
# 単一ファイルを取り込む
python main.py import "スクールフォト売上報告書_20251201.xlsx"

# ディレクトリ内の全ファイルを一括取り込む
python main.py import "C:\報告書フォルダ" --all
```

**注意事項:**
- 同じファイルを2回取り込んでも、重複データは作成されません（ファイル名で管理）
- 新しい学校やイベントは自動的にマスタに追加されます

### 2. ダッシュボードを生成してファイルサーバーに公開する

```bash
# ダッシュボードを生成してファイルサーバーに公開（推奨）
python main.py publish
```

これにより：
1. ダッシュボードHTMLを生成
2. ファイルサーバー（`\\192.168.11.51\homes\dashboard\dashboard.html`）に自動コピー

社内の人は以下のパスでアクセスできます：
```
\\192.168.11.51\homes\dashboard\dashboard.html
```

### ローカルのみで生成する場合

```bash
# ローカルにのみ生成（ファイル名は自動生成）
python main.py dashboard

# ファイル名を指定して生成
python main.py dashboard "sales_dashboard.html"
```

生成されたHTMLファイルをブラウザで開いて確認できます。

### 3. データベースの状態を確認する

```bash
python main.py status
```

取り込み済みのデータ件数と期間が表示されます。

---

## 定期運用の流れ

### 週次/月次の報告書受領時

```bash
# 1. 新しい報告書を取り込む
python main.py import "新しい報告書.xlsx"

# 2. ダッシュボードを再生成してファイルサーバーに公開
python main.py publish
```

### 初回セットアップ（過去データの一括取り込み）

```bash
# 報告書が格納されているフォルダを指定して一括取り込み
python main.py import "C:\報告書フォルダ" --all

# ダッシュボード生成
python main.py dashboard
```

---

## ダッシュボードの使い方

### 画面構成

1. **サマリーカード**（上部）
   - 累計売上、前年比、予算達成率、アラート件数を表示
   - 「月別売上推移」の年度選択と連動

2. **月別売上推移**（中央上）
   - 年度プルダウンで表示年度を切り替え可能
   - タブで「月ごと」「事業所ごと」「担当者ごと」を切り替え

3. **会員率推移・学校別売上推移**（中央下）
   - 独立した年度プルダウンで表示年度を切り替え可能
   - 属性・写真館・学校で絞り込んで検索

4. **アラート・分析**（下部）
   - 前年比大幅減の学校
   - 予算未達のイベント
   - 属性別の会員率統計

### フィルター操作

- **会員率推移**: 属性 → 写真館 → 学校 の順で絞り込み、「検索」ボタンで表示
- **学校別売上推移**: 事業所 → 写真館 → 学校 の順で絞り込み

---

## トラブルシューティング

### データベースが存在しないエラー

```bash
# 初回は自動的に作成されます
python main.py import "報告書.xlsx"
```

### データを初期化したい場合

```bash
# 警告: 全データが削除されます
python main.py init --force

# その後、再度データを取り込む
python main.py import "報告書フォルダ" --all
```

### Excelファイルの形式エラー

- シート名が正しいか確認（「学校別売上」「イベント別売上」「売上」「会員率」）
- 報告書のフォーマットが変更された場合は `importer.py` の修正が必要

---

## コマンド一覧

| コマンド | 説明 |
|---------|------|
| `python main.py import <ファイル>` | 単一Excelファイルを取り込み |
| `python main.py import <フォルダ> --all` | フォルダ内の全Excelを取り込み |
| `python main.py publish` | ダッシュボード生成＆ファイルサーバーに公開 |
| `python main.py dashboard [ファイル名]` | ダッシュボードHTML生成（ローカルのみ） |
| `python main.py status` | DB状態確認 |
| `python main.py init --force` | DB初期化（全データ削除） |

---

## 注意事項

- `schoolphoto.db` はデータベースファイルです。削除すると全データが失われます
- 生成されたHTMLファイル（`dashboard_*.html`）はGit管理外です
- 報告書のバックアップは別途保管してください
