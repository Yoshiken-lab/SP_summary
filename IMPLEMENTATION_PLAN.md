# スクールフォト売上管理システム - 実装計画書

## 1. プロジェクト概要

### 1.1 目的
SP_sales_ver1.1の集計機能とSP_summaryのダッシュボード機能を統合し、
**1つのWebアプリ**で以下を実現する：

- CSVファイルから売上・会員データを集計
- Excel報告書を出力
- データベースに保存してダッシュボードを更新

### 1.2 ユーザー区分

| ユーザー | アクセス範囲 | アクセス方法 |
|---------|-------------|-------------|
| 管理者 | 管理画面（集計・Excel出力・DB保存） | localhost:8080 |
| 一般閲覧者 | ダッシュボードのみ | ファイルサーバーのHTML |

---

## 2. システム構成

```
┌─────────────────────────────────────────────────────────────┐
│  管理者PC（localhost）                                       │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Flask Backend (Port: 設定可能)                      │   │
│  │  ├── /api/upload      ファイルアップロード           │   │
│  │  ├── /api/aggregate   集計実行                       │   │
│  │  ├── /api/export      Excel出力                      │   │
│  │  ├── /api/save-db     DB保存                         │   │
│  │  └── /api/publish     ダッシュボード生成・公開       │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↑                                  │
│                          │ HTTP                             │
│                          ↓                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Vue.js Frontend                                     │   │
│  │  ├── ファイル選択画面                                │   │
│  │  ├── 集計実行・ログ表示                              │   │
│  │  └── 結果・ダウンロード画面                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ↓ 生成                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  出力                                                │   │
│  │  ├── Excel報告書 (SP_SalesResult_YYYYMM.xlsx)       │   │
│  │  ├── SQLite DB (schoolphoto.db)                     │   │
│  │  └── dashboard.html → ファイルサーバーへ公開        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. ディレクトリ構成

```
SP_summary/
├── app/                          # 新規作成：メインアプリケーション
│   ├── __init__.py
│   ├── config.py                 # 設定（ポート、パス等）
│   ├── run.py                    # 起動スクリプト
│   │
│   ├── backend/                  # Flask API
│   │   ├── __init__.py
│   │   ├── api.py                # APIエンドポイント
│   │   ├── aggregator/           # 集計ロジック（SP_sales移植）
│   │   │   ├── __init__.py
│   │   │   ├── sales.py          # 売上集計
│   │   │   ├── summary.py        # 全体集計計算
│   │   │   ├── accounts.py       # 会員率計算
│   │   │   └── excel_output.py   # Excel出力
│   │   └── services/             # ビジネスロジック
│   │       ├── __init__.py
│   │       ├── file_handler.py   # ファイル処理
│   │       └── db_service.py     # DB保存（既存importer活用）
│   │
│   └── frontend/                 # Vue.js
│       ├── index.html
│       ├── package.json
│       ├── vite.config.js
│       └── src/
│           ├── main.js
│           ├── App.vue
│           ├── style.css
│           └── components/
│               ├── FileUploader.vue    # ファイル選択
│               ├── ProcessingView.vue  # 集計処理・ログ
│               └── ResultView.vue      # 結果・ダウンロード
│
├── database.py                   # 既存：DB定義（そのまま利用）
├── importer.py                   # 既存：インポート（そのまま利用）
├── dashboard.py                  # 既存：ダッシュボード生成（そのまま利用）
├── alerts.py                     # 既存：アラート（そのまま利用）
├── analytics.py                  # 既存：分析（そのまま利用）
├── member_rate_chart.py          # 既存：会員率グラフ（そのまま利用）
├── main.py                       # 既存：CLIコマンド（そのまま利用）
│
├── schoolphoto.db                # 既存：データベース
└── config.json                   # 既存：AI設定
```

---

## 4. 画面設計

### 4.1 メイン画面（ファイル選択）

```
┌──────────────────────────────────────────────────────────────┐
│  スクールフォト 売上集計システム                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  STEP 1: データファイルを選択                           │ │
│  │                                                        │ │
│  │  📄 売上データ (CSV)                                   │ │
│  │  ┌─────────────────────────────────┐ ┌──────────────┐ │ │
│  │  │ ファイルが選択されていません     │ │ 選択...      │ │ │
│  │  └─────────────────────────────────┘ └──────────────┘ │ │
│  │                                                        │ │
│  │  📄 会員データ (CSV)                                   │ │
│  │  ┌─────────────────────────────────┐ ┌──────────────┐ │ │
│  │  │ ファイルが選択されていません     │ │ 選択...      │ │ │
│  │  └─────────────────────────────────┘ └──────────────┘ │ │
│  │                                                        │ │
│  │  📄 担当者マスタ (XLSX)                                │ │
│  │  ┌─────────────────────────────────┐ ┌──────────────┐ │ │
│  │  │ ファイルが選択されていません     │ │ 選択...      │ │ │
│  │  └─────────────────────────────────┘ └──────────────┘ │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  STEP 2: 対象期間を選択                                 │ │
│  │                                                        │ │
│  │  年度: [ 2025年度 ▼ ]    月: [ 12月 ▼ ]               │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  STEP 3: 出力オプション                                 │ │
│  │                                                        │ │
│  │  ☑ Excel報告書を出力                                   │ │
│  │  ☑ データベースに保存（ダッシュボード用）              │ │
│  │  ☐ ダッシュボードを自動更新・公開                      │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│              ┌─────────────────────────────┐                │
│              │      🚀 集計を実行          │                │
│              └─────────────────────────────┘                │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 処理中画面

```
┌──────────────────────────────────────────────────────────────┐
│  スクールフォト 売上集計システム                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  処理状況                                               │ │
│  │                                                        │ │
│  │  [████████████████████░░░░░░░░░░] 65%                  │ │
│  │                                                        │ │
│  │  ✅ 売上データ読み込み完了 (1,234件)                   │ │
│  │  ✅ 会員データ読み込み完了 (456件)                     │ │
│  │  ✅ マスタデータ読み込み完了                           │ │
│  │  ✅ 全体売上集計完了                                   │ │
│  │  🔄 事業所別集計中...                                  │ │
│  │  ⏳ 担当者別集計                                       │ │
│  │  ⏳ イベント別集計                                     │ │
│  │  ⏳ 会員率計算                                         │ │
│  │  ⏳ Excel出力                                          │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 4.3 完了画面

```
┌──────────────────────────────────────────────────────────────┐
│  スクールフォト 売上集計システム                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                                                        │ │
│  │                    ✅ 集計完了                         │ │
│  │                                                        │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  集計結果サマリー                                       │ │
│  │                                                        │ │
│  │  総売上:           ¥12,345,678                         │ │
│  │  ├ 直取引:         ¥3,456,789                          │ │
│  │  └ 写真館・学校:   ¥8,888,889                          │ │
│  │  実施学校数:       123校                               │ │
│  │  売上/学校:        ¥100,371                            │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  出力ファイル                                           │ │
│  │                                                        │ │
│  │  📥 SP_SalesResult_202512.xlsx                         │ │
│  │     ┌──────────────────┐                               │ │
│  │     │  ダウンロード    │                               │ │
│  │     └──────────────────┘                               │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌──────────────────┐  ┌──────────────────────────────────┐ │
│  │ 新規集計を開始   │  │ ダッシュボードを開く（別タブ）   │ │
│  └──────────────────┘  └──────────────────────────────────┘ │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 5. API設計

### 5.1 エンドポイント一覧

| メソッド | パス | 説明 |
|---------|------|------|
| POST | `/api/upload` | ファイルアップロード（3ファイル） |
| POST | `/api/aggregate` | 集計実行 |
| GET | `/api/progress` | 進捗状況取得（SSE） |
| GET | `/api/download/{filename}` | Excelダウンロード |
| POST | `/api/save-db` | DB保存 |
| POST | `/api/publish` | ダッシュボード生成・公開 |
| GET | `/api/config` | 設定取得 |

### 5.2 レスポンス例

**POST /api/aggregate**
```json
{
  "status": "success",
  "summary": {
    "total_sales": 12345678,
    "direct_sales": 3456789,
    "studio_sales": 8888889,
    "school_count": 123,
    "sales_per_school": 100371
  },
  "output_file": "SP_SalesResult_202512.xlsx"
}
```

---

## 6. 集計ロジック（SP_sales_ver1.1からの移植）

### 6.1 移植対象

| 元ファイル | 移植先 | 主要機能 |
|-----------|--------|---------|
| sales.py | aggregator/sales.py | narrow_downクラス（全体/事業所/担当者/イベント） |
| summary.py | aggregator/summary.py | 総売上計算、直取引/写真館分離 |
| accounts.py | aggregator/accounts.py | 会員率計算 |
| output.py | aggregator/excel_output.py | Excel出力 |

### 6.2 改善点

| 項目 | 現状 | 改善 |
|------|------|------|
| クラス変数 | グローバル状態 | インスタンス変数に変更 |
| エラー処理 | sys.exit() | 例外をraiseして上位で処理 |
| ログ出力 | print | logging + WebSocket/SSE |
| 会員率条件 | or判定（バグ） | and判定に修正 |

---

## 7. 実装フェーズ

### Phase 1: 基盤構築
1. ディレクトリ構成作成
2. Flask APIの雛形作成
3. Vue.jsプロジェクト初期化
4. 設定ファイル（config.py）作成

### Phase 2: 集計ロジック移植
1. sales.py の移植・リファクタリング
2. summary.py の移植
3. accounts.py の移植
4. excel_output.py の移植
5. 単体テスト

### Phase 3: API実装
1. ファイルアップロードAPI
2. 集計実行API
3. 進捗通知（SSE）
4. Excel ダウンロードAPI

### Phase 4: フロントエンド実装
1. ファイル選択画面
2. 処理中画面（プログレス表示）
3. 結果画面

### Phase 5: DB連携・ダッシュボード
1. 既存importer.pyとの連携
2. ダッシュボード自動生成
3. ファイルサーバーへの公開

### Phase 6: 仕上げ
1. エラーハンドリング強化
2. ポート可変対応
3. 起動スクリプト整備
4. 動作確認・調整

---

## 8. 設定ファイル

### config.py
```python
import os
from pathlib import Path

class Config:
    # サーバー設定
    HOST = os.getenv('HOST', '127.0.0.1')
    PORT = int(os.getenv('PORT', 8080))
    DEBUG = os.getenv('DEBUG', 'false').lower() == 'true'

    # パス設定
    BASE_DIR = Path(__file__).parent.parent
    DB_PATH = BASE_DIR / 'schoolphoto.db'
    OUTPUT_DIR = Path.home() / 'Downloads'

    # ダッシュボード公開先
    PUBLISH_PATH = Path(r'\\192.168.11.51\homes\dashboard')
    PUBLISH_FILENAME = 'dashboard.html'

    # ファイルエンコーディング
    CSV_ENCODING = 'cp932'
```

---

## 9. 起動方法

```bash
# デフォルト起動（ポート8080）
python -m app.run

# ポート指定
python -m app.run --port 9000

# 環境変数で指定
set PORT=9000
python -m app.run

# デバッグモード
python -m app.run --debug
```

---

## 10. 確認事項

実装を始める前に、以下を確認させてください：

1. **ポートのデフォルト値**: 8080でよいか？
2. **Excel出力先**: ~/Downloads でよいか？
3. **ダッシュボード公開先**: `\\192.168.11.51\homes\dashboard` でよいか？
4. **年度の扱い**: 4月始まり（4-12月が当年度、1-3月が前年度）でよいか？

---

以上の計画で実装を進めます。
